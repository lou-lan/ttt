# EgressTunnel CRD

```yaml
apiVersion: egressgateway.spidernet.io/v1
kind: EgressTunnel
metadata:
  name: "node1"
spec:
status:
  phase: "Ready"
  vxlanIPv4IP: "172.31.0.10/16"
  vxlanIPv6IP: "fe80::/64"
  tunnelMac: "xx:xx:xx:xx:xx"
  physicalInterface: "eth1"
  physicalInterfaceIPv4: ""
  physicalInterfaceIPv6: ""
```

Used to store information about each node's tunnel, generated by monitoring the node.

Field Description

* status
  * `phase` indicates the status of the EgressTunnel, 'Ready' tunnel IP has been assigned and the tunnel has been built, 'Pending' waiting for IP assignment, 'Init ' Tunnel IP assigned successfully, 'Failed' Tunnel IP failed to be assigned.
  * `vxlanIPv4IP` Tunnel IPV4 address
  * `vxlanIPv6IP` tunnel IPV6 address
  * `tunnelMac` tunnel Mac address
  * `physicalInterface` Tunnel parent NIC
  * `physicalInterfaceIPv4` The IPV4 address of the parent NIC.
  * `physicalInterfaceIPv6` IPV6 address of the parent NIC.

## Controller implementation

### Initialization

1. Get IPv4, IPv6 and corresponding CIDR from CM. 2.
2. will check if the node has a corresponding EgressTunnel, if not, create a corresponding EgressTunnel with status set to "pending". If there is a tunnel IP, then bind the IP to the node, before binding, it will check if the IP is legal, if not, it will set the status to "Pending".

### Node events

* Delete event: delete the corresponding EgressTunnel.
* Other events: create EgressTunnel if there is no corresponding EgressTunnel.
* Other events: if there is a corresponding EgressTunnel, validate the EgressTunnel. The calibration logic is as follows:

  * If there is no tunnel IP, set the status to "Pending"
  * If there is a tunnel IP, determine whether it is legal or not, if not, set the state to "Pending"
  * If it is legal, check whether the IP has been allocated, if it has been allocated, and allocated to other nodes, then set the state to "Pending"
  * If it has not been allocated to other nodes, it is allocated to this "EgressTunnel", set the state to "Init"
  * If it has been allocated, and it is the one allocated to this node, set the state to "Init"

### EgressTunnel events

* Delete event: release IP first. if the node corresponding to EgressTunnel exists, release IP and recreate EgressTunnel.
* Other events: If the EgressTunnel status is "Init" or "Ready", do nothing. If not, the IP is allocated and the status is set to "Init" for successful allocation and "Failed" for failed allocation. This is the only place globally where tunnel IPs are assigned

## Assign tunnel IP

* When the controller starts up, it gets the tunnel IP CRID from config and maintains a map in memory to record whether the IP has been allocated or not.
* Tunnel IPs are centered, so they are allocated serially, randomly among the unallocated IPs.
* Before allocating, detect tunnel IP conflict, allocate again if there is no conflict (implementation to be decided)

## Other

* When the controller starts up, it checks the IP of the CRD it is associated with, and the final state is set to "Init" or "Failed" (this is debatable).
* If the agent detects the phase field of the corresponding CRD is "Init", it will create the corresponding tunnel and route, and update to "Ready" state if it succeeds in creating the tunnel and route. If it fails, it will not be updated.
* Mac address format: generated by SHA1 algorithm based on node name, so the Mac address of each node is fixed.
